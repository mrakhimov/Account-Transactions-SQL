-- Name: Moonie Rakhimov
-- Seneca Student ID: 024-958-118
-- Seneca email: mshakhnazarova@myseneca.ca
-- Date of completion: April 17, 2020


CREATE SEQUENCE a3_accounts_seq
START WITH 1001
INCREMENT BY 99;

CREATE TABLE A3_ACCOUNT_TYPES(
	AccountType	VARCHAR2(1)	NOT NULL	PRIMARY KEY,
	TypeName	VARCHAR2(15)	NOT NULL
);

CREATE TABLE A3_CUSTOMERS (
	customerID  INT     NOT NULL       PRIMARY KEY,
	firstName   VARCHAR2(20)    NOT NULL,
	lastName    VARCHAR2(20)	NOT NULL,
	email       VARCHAR2(50)	NOT NULL,
	DOB			DATE,
	phone       VARCHAR2(10)
);


CREATE TABLE A3_ACCOUNTS(
	accountNo   	INT DEFAULT a3_accounts_seq.NEXTVAL  PRIMARY KEY,
	accountType 	VARCHAR2(1) DEFAULT 'C' NOT NULL,
	customerID  	INT  GENERATED BY DEFAULT AS IDENTITY   NOT NULL,
	currentBalance  DECIMAL(10, 2) DEFAULT (0.00)  NOT NULL,
	dtOpen  		DATE  DEFAULT to_char(sysdate, 'yyyymmdd'),
	isActive    	SMALLINT  DEFAULT (1)     NOT NULL,
	CONSTRAINT fk_accountType_a3_accounts FOREIGN KEY (accountType) REFERENCES a3_account_types,
	CONSTRAINT fk_customerID_a3_accounts FOREIGN KEY (customerID) REFERENCES a3_customers,
	CONSTRAINT ck_currentBalance CHECK (currentBalance>0)
);

CREATE TABLE A3_TRANSACTIONS (
	transactionID		INT				NOT NULL  PRIMARY KEY ,
	accountNo         	INT       		NOT NULL,
	transactionType   	VARCHAR2(1)		NOT NULL,
	amount  			DECIMAL(10,2) 	DEFAULT (0)    NOT NULL,
	description     	VARCHAR2(25)    NOT NULL,
	transDate  			DATE    		DEFAULT to_char(sysdate,'yyyymmdd')  NOT NULL,
	refNum      		VARCHAR2(12),
	CONSTRAINT fk_accountNo_a3_transactions FOREIGN KEY (accountNo) REFERENCES a3_accounts
);

COMMIT;

-- QUESTION 1 --

-- a --
INSERT INTO A3_CUSTOMERS
	VALUES (01, 'Moonie', 'Rakhimov', 'mshakhnazarova@myseneca.ca', '19921231', '6479999999' );

COMMIT;


-- b --
INSERT INTO A3_ACCOUNT_TYPES VALUES ('C', 'Chequing');
INSERT INTO A3_ACCOUNTS VALUES (1100, 'C', 01, 0.01, sysdate,1);
INSERT INTO A3_TRANSACTIONS VALUES (99999, 1100, 'C', 500.00, 'ATM Deposit', sysdate, 'REF001');
UPDATE A3_ACCOUNTS SET currentBalance = 500 WHERE accountNo =1100;
COMMIT;

-- c --
INSERT INTO A3_ACCOUNT_TYPES VALUES ('S', 'Savings');
INSERT INTO A3_ACCOUNTS VALUES (1101, 'S', 01, 0.01, sysdate,1);
INSERT INTO A3_TRANSACTIONS VALUES (99998, 1101, 'C', 1000.00, 'E-interac Deposit', sysdate, 'REF002');
UPDATE A3_ACCOUNTS SET currentBalance = 1000 WHERE accountNo =1101;
COMMIT;


-- d --
INSERT INTO A3_TRANSACTIONS VALUES (99997, 1100, 'D', -112.34, 'Walmart Purchase', sysdate, 'REF003');
UPDATE A3_ACCOUNTS SET currentBalance = (currentBalance - 112.34) WHERE accountNo = 1100;
COMMIT;


-- e --
INSERT INTO A3_TRANSACTIONS VALUES (99996, 1100, 'D', -1.99, 'iTUNES Purchase', sysdate, 'CQ3E5RZ');
UPDATE A3_ACCOUNTS SET currentBalance = (currentBalance - 1.99) WHERE accountNo = 1100;
COMMIT;


-- f --

INSERT INTO A3_TRANSACTIONS VALUES (99995, 1100, 'D', -1600, 'CHQ1100005', sysdate, 'REF005');
UPDATE A3_ACCOUNTS SET currentBalance = (currentBalance - 1600) WHERE accountNo = 1100;
COMMIT;


-- g --

INSERT INTO A3_TRANSACTIONS VALUES (99994, 1100, 'D', -45, 'NSF - Fee', sysdate, 'REF006');
UPDATE A3_ACCOUNTS SET currentBalance = (currentBalance - 45) WHERE accountNo = 1100;
COMMIT;


-- h --

INSERT INTO A3_TRANSACTIONS VALUES (99993, 1101, 'C', 2000, 'RESP school expenses', sysdate, 'REF007');
UPDATE A3_ACCOUNTS SET currentBalance = (currentBalance + 2000) WHERE accountNo = 1101;
COMMIT;


-- i --

INSERT INTO A3_TRANSACTIONS VALUES (99992, 1100, 'C', 1600, 'last month rent', sysdate, 'REF008');
UPDATE A3_ACCOUNTS SET currentBalance = (currentBalance + 1600) WHERE accountNo = 1100;
COMMIT;

INSERT INTO A3_TRANSACTIONS VALUES (99991, 1100, 'D', -25, 'Landlord fee', sysdate, 'REF009');
UPDATE A3_ACCOUNTS SET currentBalance = (currentBalance - 25) WHERE accountNo = 1100;
COMMIT;

INSERT INTO A3_TRANSACTIONS VALUES (99990, 1100, 'D', -8, 'Check deposit charge bank', sysdate, 'REF009');
UPDATE A3_ACCOUNTS SET currentBalance = (currentBalance - 8) WHERE accountNo = 1100;
COMMIT;


-- j -- 

INSERT INTO A3_TRANSACTIONS VALUES (99989, 1100, 'D', -40, 'ATM withdrawal', sysdate, 'REF010');
UPDATE A3_ACCOUNTS SET currentBalance = (currentBalance - 40) WHERE accountNo = 1100;
COMMIT;


-- k --

INSERT INTO A3_TRANSACTIONS VALUES (99988, 1100, 'D', -64.45, 'ROGERS 345678 X8U2', sysdate, 'REF011');
UPDATE A3_ACCOUNTS SET currentBalance = (currentBalance - 64.45) WHERE accountNo = 1100;
COMMIT;


-- QUESTION 2 --

-- a --

-- For CHEQUING ACCOUNT
SELECT transactionID "transID",
    to_char(transdate, 'MM/DD/YYYY')  "Date",
    description "Details",
    amount "Amount",
    SUM(amount) OVER (PARTITION BY accountno ORDER BY transDate) AS Balance
FROM A3_TRANSACTIONS
WHERE accountno = 1100
ORDER BY transdate;
-- For SAVINGS ACCOUNT
SELECT transactionID "transID",
    to_char(transdate, 'MM/DD/YYYY')  "Date",
    description "Details",
    amount "Amount",
    SUM(amount) OVER (PARTITION BY accountno ORDER BY transDate) AS Balance
FROM A3_TRANSACTIONS
WHERE accountno = 1101
ORDER BY transdate;


-- b -- 
-- CHEQUING
SELECT accountno, 
    (SELECT SUM(amount) FROM A3_TRANSACTIONS WHERE transactiontype LIKE 'D')
 "Total Debits", 
    (SELECT SUM(amount) FROM A3_TRANSACTIONS WHERE transactiontype LIKE 'C')
"Total Credits"
FROM A3_TRANSACTIONS
WHERE accountno=1100
GROUP BY accountno;
-- SAVINGS
SELECT accountno, 
    (SELECT SUM(amount) FROM A3_TRANSACTIONS WHERE transactiontype LIKE 'D')
 "Total Debits", 
    (SELECT SUM(amount) FROM A3_TRANSACTIONS WHERE transactiontype LIKE 'C')
"Total Credits"
FROM A3_TRANSACTIONS
WHERE accountno=1101


-- c -- 

-- CHEQUING
SELECT accountno, SUM(amount) - (SELECT currentBalance
FROM a3_accounts where accountno = 1100) AS "Difference"
FROM A3_TRANSACTIONS
WHERE accountno=1100
GROUP BY accountno;
-- 1600 difference becuase the check bounced



-- SAVINGS
SELECT accountno, SUM(amount) - (SELECT currentBalance
FROM a3_accounts where accountno = 1101) AS "Difference"
FROM A3_TRANSACTIONS
WHERE accountno=1101
GROUP BY accountno;
-- 0 difference



-- QUESTION 3 --

--In this course I learned about Oracle 11g and it's transactions and functions. Unlike DBS201 
--Oralce has a rich functions and transaction support. I did learn a lot about transactions in this course.
--Now I have a better understanding of scenarios to a real world database operations, I'll be very careful
--when dealing with Data :)
